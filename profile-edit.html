<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>プロフィール設定 - うちあけ</title>
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&family=Klee+One&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .font-klee-one {
            font-family: 'Klee One', cursive;
        }
        .notification-bell::after {
            content: attr(data-count);
            position: absolute;
            top: -4px;
            right: -6px;
            width: 18px;
            height: 18px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        .setting-card h2 {
            font-size: 1.25rem;
            font-weight: 700;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        /* Toggle switch style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #f97316;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #f97316;
        }
            /* --- プロフィール充実度メーター --- */
        .progress-bar-bg {
            background-color: #e5e7eb;
        }
        .progress-bar-fill {
            background-color: #f59e0b; /* amber-500 */
            transition: width 0.5s ease-in-out;
        }

        /* --- うちあけカード用のスタイル --- */
        .uchiake-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
        }
        .uchiake-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.07);
        }
        .uchiake-card.selected {
            border-color: #f97316; /* orange-500 */
            background-color: #fff7ed; /* orange-50 */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
        }
        .uchiake-card.selected .icon-container {
            background-color: #f97316;
            color: white;
        }
        .uchiake-card.max-selected:not(.selected) {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: #f8fafc;
            border-color: #e5e7eb;
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .selected-checkmark {
            display: none;
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: #22c55e;
            color: white;
            border-radius: 50%;
            border: 2px solid white;
        }
        .uchiake-card.selected .selected-checkmark {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .custom-card-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            border: 2px solid white;
            font-size: 12px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .uchiake-card.custom-card:hover .custom-card-remove-btn {
            opacity: 1;
        }
        
        /* --- タグ入力 --- */
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #14b8a6; /* teal-500 */
            color: white;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
        }
        .tag-remove-btn {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* --- きっかけボタン --- */
        .prompt-button {
            transition: all 0.2s ease-in-out;
        }
        .prompt-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }


        /* --- モーダル --- */
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- ヘッダー (ログイン後) -->
    <header class="fixed top-0 w-full z-40 flex items-center justify-between px-4 py-2 bg-white shadow-md">
        <h1 class="flex justify-start text-xl font-bold">
            <a class="flex items-center text-gray-800" href="profile">
                <img alt="うちあけ ロゴ" class="rounded-full shadow-sm" height="40" src="https://placehold.co/40x40/FFDDC1/FF6B35?text=U" width="40" />
                <p class="ml-2 whitespace-nowrap text-orange-500 font-klee-one text-2xl">うちあけ</p>
            </a>
        </h1>
        <div class="grow"></div>
        <nav class="flex items-center gap-4 sm:gap-6">
            <a href="notification" class="relative text-gray-600 hover:text-orange-500 transition notification-bell" data-count="2" title="通知">
                <i class="fas fa-bell text-2xl"></i>
            </a>
            <a href="profile" class="flex items-center gap-2 hover:opacity-80 transition" title="マイページ">
                <img src="https://placehold.co/40x40/a7f3d0/166534?text=A" alt="プロフィール画像" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-orange-200">
                <span class="hidden sm:inline font-semibold text-gray-700">あなたさん</span>
            </a>
        </nav>
    </header>

    <!-- メインコンテンツ -->
    <main class="pt-[68px] pb-24">
        <div class="container mx-auto max-w-3xl px-4 py-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-8">プロフィール設定</h1>
            <!-- プロフィール充実度メーター -->
            <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold text-gray-700">プロフィール充実度</h3>
                    <span id="progress-percent" class="font-bold text-green-600 text-lg">0%</span>
                </div>
                <div class="progress-bar-bg w-full rounded-full h-3">
                    <div id="progress-bar" class="progress-bar-fill h-3 rounded-full" style="width: 0%;"></div>
                </div>
                <p id="progress-message" class="text-xs text-gray-500 mt-2">プロフィールを充実させて、他の人との繋がりを深めましょう！</p>
            </section>
            <!-- 基本プロフィール -->
            <section class="setting-card bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
                <h2 class="mb-6">基本プロフィール</h2>
                <div class="space-y-6">
                    <!-- プロフィール画像 -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">プロフィール画像</label>
                        <div class="flex items-center gap-4">
                            <img src="https://placehold.co/80x80/a7f3d0/166534?text=A" alt="現在のプロフィール画像" class="w-20 h-20 rounded-full">
                            <button class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition text-sm">
                                <i class="fas fa-camera mr-2"></i>画像を変更
                            </button>
                        </div>
                    </div>
                    <!-- ニックネーム -->
                    <div>
                        <label for="nickname" class="block text-sm font-semibold text-gray-700 mb-2">ニックネーム</label>
                        <input type="text" id="nickname" value="あなたさん" class="w-full max-w-sm p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400">
                    </div>
                    <!-- 自己紹介 -->
                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <label for="bio" class="block text-sm font-semibold text-gray-700">自己紹介</label>
                            <span class="text-xs text-gray-500">何を書くか迷ったら、以下の【きっかけボタン】から書き進めてください</span>
                        </div>
                        <!-- きっかけボタン -->
                        <div id="prompt-buttons" class="flex flex-wrap gap-2 mb-3">
                            <button class="prompt-button text-xs font-semibold bg-sky-100 text-sky-700 py-1 px-3 rounded-full" data-topic="me">わたしのこと</button>
                            <button class="prompt-button text-xs font-semibold bg-rose-100 text-rose-700 py-1 px-3 rounded-full" data-topic="hobby">好きなこと・趣味</button>
                            <button class="prompt-button text-xs font-semibold bg-teal-100 text-teal-700 py-1 px-3 rounded-full" data-topic="health">病気や症状について</button>
                            <button class="prompt-button text-xs font-semibold bg-amber-100 text-amber-700 py-1 px-3 rounded-full" data-topic="community">うちあけで話したいこと</button>
                        </div>
                        <textarea id="bio" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400" placeholder="ボタンを押して書き始めてみましょう！もちろん自由入力も歓迎です。"></textarea>
                    </div>
                </div>
                <div class="text-right mt-6">
                    <button class="bg-orange-500 text-white font-bold py-2 px-6 rounded-full hover:bg-orange-600 transition shadow">更新する</button>
                </div>
            </section>
                
            <!-- わたしのからだ記録 Section -->
            <section class="setting-card bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
                <h2 class="mb-2 font-klee-one text-teal-600">わたしのからだ記録</h2>
                <p class="text-sm text-gray-600 mb-6">
                    「うちあけ」として投稿する前に、まずはあなたのことについて教えてください。同じ悩みを持つ方と繋がるきっかけになります。
                </p>
                <div class="mb-6">
                    <h3 class="text-md font-semibold text-gray-800 mb-2">疾患名・症状</h3>
                    <div id="tags-container-disease" class="flex flex-wrap gap-2 mb-2 p-2 border rounded-lg min-h-[48px] bg-gray-50"></div>
                    <div class="flex gap-2">
                        <input type="text" id="tag-input-disease" class="flex-grow p-2 border border-gray-300 rounded-lg" placeholder="例：関節リウマチ" aria-label="疾患名・症状を入力">
                        <button data-input="tag-input-disease" data-container="tags-container-disease" class="add-tag-btn bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">追加</button>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-md font-semibold text-gray-800 mb-2">受けている治療</h3>
                    <div id="tags-container-treatment" class="flex flex-wrap gap-2 mb-2 p-2 border rounded-lg min-h-[48px] bg-gray-50"></div>
                    <div class="flex gap-2">
                        <input type="text" id="tag-input-treatment" class="flex-grow p-2 border border-gray-300 rounded-lg" placeholder="例：薬物療法" aria-label="受けている治療を入力">
                        <button data-input="tag-input-treatment" data-container="tags-container-treatment" class="add-tag-btn bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">追加</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-md font-semibold text-gray-800 mb-2">普段のケア</h3>
                    <div id="tags-container-care" class="flex flex-wrap gap-2 mb-2 p-2 border rounded-lg min-h-[48px] bg-gray-50"></div>
                    <div class="flex gap-2">
                        <input type="text" id="tag-input-care" class="flex-grow p-2 border border-gray-300 rounded-lg" placeholder="例：週2回のストレッチ" aria-label="普段のケアを入力">
                        <button data-input="tag-input-care" data-container="tags-container-care" class="add-tag-btn bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">追加</button>
                    </div>
                </div>
            </section>

            <!-- うちあけカード Section -->
            <section class="setting-card bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
                <h2 class="mb-2 font-klee-one text-orange-600">うちあけカードで人柄を伝えよう</h2>
                <p class="text-sm text-gray-600 mb-6">タップで選ぶだけで、あなたのことがもっと伝わります。他のユーザーとの温かい交流のきっかけにもなります。</p>
                <div class="mb-8">
                    <h3 class="text-md font-semibold text-gray-800 mb-1">あなたが大切にしていることは？</h3>
                    <p class="text-xs text-gray-500 mb-4">最大3つまで選べます</p>
                    <div id="value-cards" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                </div>
                <div class="mb-8">
                     <h3 class="text-md font-semibold text-gray-800 mb-1">気分が落ち込んだ時、どうすることが多いですか？</h3>
                     <p class="text-xs text-gray-500 mb-4">あなたの対処法を教えてください（最大3つ）</p>
                     <div id="coping-cards" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                </div>
                <div class="mb-8">
                     <h3 class="text-md font-semibold text-gray-800 mb-1">心と体のセルフケアで、心がけていることは？</h3>
                     <p class="text-xs text-gray-500 mb-4">最大3つまで選べます</p>
                     <div id="selfcare-cards" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                </div>
                <div>
                    <h3 class="text-md font-semibold text-gray-800 mb-1">他のユーザーと、どのように関わりたいですか？</h3>
                    <p class="text-xs text-gray-500 mb-4">1つだけ選んでください</p>
                    <div id="stance-cards" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
                </div>
            </section>

            <!-- ログインと連携 -->
            <section class="setting-card bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
                <h2 class="mb-6">ログインと連携</h2>
                <div class="space-y-6">
                    <!-- メールアドレスとパスワード -->
                    <div>
                        <p class="text-sm font-semibold text-gray-700">メールアドレスでログイン中</p>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-2">
                            <p class="text-gray-600">user@example.com</p>
                            <button class="w-full sm:w-auto mt-2 sm:mt-0 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition text-sm">パスワードを変更</button>
                        </div>
                    </div>
                    <!-- Google連携 -->
                    <div class="pt-6 border-t">
                         <p class="text-sm font-semibold text-gray-700 mb-2">ソーシャル連携</p>
                         <div class="flex flex-col sm:flex-row justify-between items-center">
                            <div class="flex items-center">
                                <i class="fab fa-google text-2xl text-red-500 mr-3 w-6 text-center"></i>
                                <div>
                                    <p class="font-semibold text-gray-800">Google</p>
                                    <p class="text-xs text-gray-500">連携されていません</p>
                                </div>
                            </div>
                            <button class="w-full sm:w-auto mt-2 sm:mt-0 bg-blue-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-600 transition text-sm">連携する</button>
                        </div>
                    </div>
                    <!-- LINE連携 -->
                    <div class="pt-4 mt-4 border-t">
                         <div class="flex flex-col sm:flex-row justify-between items-center">
                            <div class="flex items-center">
                                <i class="fab fa-line text-2xl text-green-500 mr-3 w-6 text-center"></i>
                                <div>
                                    <p class="font-semibold text-gray-800">LINE</p>
                                    <p class="text-xs text-gray-500">連携済み</p>
                                </div>
                            </div>
                            <button class="w-full sm:w-auto mt-2 sm:mt-0 bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-full hover:bg-red-200 transition text-sm">連携を解除</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 通知設定 -->
            <section class="setting-card bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-8">
                <h2 class="mb-6">通知設定</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-700">共感があった時</p>
                            <p class="text-xs text-gray-500">あなたの投稿やコメントに共感がついた時に通知します。</p>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-empathy" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                            <label for="toggle-empathy" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4 border-t">
                        <div>
                            <p class="font-semibold text-gray-700">コメントがあった時</p>
                            <p class="text-xs text-gray-500">あなたの投稿にコメントがついた時に通知します。</p>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-comment" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                            <label for="toggle-comment" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                     <div class="flex justify-between items-center pt-4 border-t">
                        <div>
                            <p class="font-semibold text-gray-700">返信があった時</p>
                            <p class="text-xs text-gray-500">あなたのコメントに返信がついた時に通知します。</p>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-reply" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="toggle-reply" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4 border-t">
                        <div>
                            <p class="font-semibold text-gray-700">運営からのお知らせ</p>
                            <p class="text-xs text-gray-500">メンテナンスや重要なお知らせを通知します。</p>
                        </div>
                         <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-admin" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                            <label for="toggle-admin" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </section>
            <!-- 保存ボタン -->
            <div class="mt-10 text-center">
                 <button class="bg-orange-500 text-white font-bold py-3 px-10 rounded-full hover:bg-orange-600 transition shadow-lg text-lg">
                    <i class="fas fa-save mr-2"></i>すべての設定を保存する
                </button>
            </div><br><br>

            <!-- 自由記述カード用モーダル -->
            <div id="custom-card-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
                <div id="custom-card-overlay" class="modal-overlay absolute inset-0 bg-black bg-opacity-50"></div>
                <div id="custom-card-content" class="modal-content relative bg-white rounded-xl shadow-2xl w-11/12 max-w-sm p-6 transform scale-95 opacity-0">
            <h3 class="text-lg font-bold text-gray-800 mb-4">自由記述カード作成</h3>
            <input type="text" id="custom-card-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400" placeholder="10文字以内で入力" maxlength="10">
            <div class="flex justify-end gap-3 mt-4">
                <button id="custom-card-cancel" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition text-sm">キャンセル</button>
                <button id="custom-card-save" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-orange-600 transition text-sm">保存する</button>
                </div>
                </div>
            </div>
        </div>
    </main>

    <!-- フッター -->
    <footer class="mt-8 bg-gray-100 py-6 sm:py-8 text-gray-800">
        <div class="text-center text-xs sm:text-sm text-gray-500">&copy; 2025 うちあけ All rights reserved.</div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- うちあけカードのデータ ---
            const cardData = {
                values: [ { id: 'value-family', icon: 'fa-solid fa-people-roof', text: '家族との時間' }, { id: 'value-hobby', icon: 'fa-solid fa-gamepad', text: '趣味を楽しむ' }, { id: 'value-rest', icon: 'fa-solid fa-bed', text: 'ゆっくり休む' }, { id: 'value-food', icon: 'fa-solid fa-utensils', text: '美味しい食事' }, { id: 'value-friends', icon: 'fa-solid fa-user-group', text: '友人との交流' }, { id: 'value-work', icon: 'fa-solid fa-briefcase', text: '仕事・学び' }, ],
                coping: [ { id: 'coping-music', icon: 'fa-solid fa-music', text: '音楽を聴く' }, { id: 'coping-tea', icon: 'fa-solid fa-mug-hot', text: '温かい飲み物' }, { id: 'coping-talk', icon: 'fa-solid fa-comments', text: '誰かに話す' }, { id: 'coping-movie', icon: 'fa-solid fa-film', text: '映画・動画' }, { id: 'coping-sleep', icon: 'fa-solid fa-moon', text: 'とにかく寝る' }, { id: 'coping-nature', icon: 'fa-solid fa-leaf', text: '自然に触れる' }, ],
                selfcare: [ { id: 'selfcare-stretch', icon: 'fa-solid fa-person-stretching', text: 'ストレッチ' }, { id: 'selfcare-bath', icon: 'fa-solid fa-bath', text: 'ゆっくり入浴' }, { id: 'selfcare-sun', icon: 'fa-solid fa-sun', text: '日光浴' }, { id: 'selfcare-aroma', icon: 'fa-solid fa-wind', text: 'アロマを焚く' }, { id: 'selfcare-journal', icon: 'fa-solid fa-book-open', text: '日記を書く' }, { id: 'selfcare-digital-detox', icon: 'fa-solid fa-mobile-screen-button', text: 'スマホ断ち' }, ],
                stance: [ { id: 'stance-listen', icon: 'fa-solid fa-ear-listen', text: '話を聞いてほしい' }, { id: 'stance-exchange', icon: 'fa-solid fa-lightbulb', text: '情報交換したい' }, { id: 'stance-watch', icon: 'fa-solid fa-eye', text: 'そっと見守って' }, ]
            };

            function renderCards(containerId, data, isMultiSelect = false) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                data.forEach(item => {
                    const card = document.createElement('div');
                    card.id = item.id;
                    card.className = 'uchiake-card bg-white p-3 rounded-lg shadow-sm border flex flex-col items-center justify-center text-center';
                    card.innerHTML = `<div class="selected-checkmark"><i class="fas fa-check text-xs"></i></div><div class="icon-container w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 text-xl mb-2 transition-colors"><i class="${item.icon}"></i></div><span class="text-xs font-semibold text-gray-700">${item.text}</span>`;
                    container.appendChild(card);
                });
                if (isMultiSelect) {
                    const addCard = document.createElement('div');
                    addCard.className = 'uchiake-card add-custom-card bg-gray-50 border-dashed p-3 rounded-lg shadow-sm border-2 flex flex-col items-center justify-center text-center text-gray-400 hover:border-orange-400 hover:text-orange-500';
                    addCard.dataset.targetContainer = containerId;
                    addCard.innerHTML = `<div class="icon-container w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-lg mb-2"><i class="fa-solid fa-plus"></i></div><span class="text-xs font-semibold">自由記述</span>`;
                    container.appendChild(addCard);
                }
            }

            function setupMultiSelect(containerId, maxSelection) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.addEventListener('click', (e) => {
                    const addCardButton = e.target.closest('.add-custom-card');
                    if (addCardButton) {
                        openCustomCardModal(addCardButton.dataset.targetContainer);
                        return;
                    }

                    const card = e.target.closest('.uchiake-card');
                    if (!card) return;

                    if (e.target.closest('.custom-card-remove-btn')) { 
                        card.remove(); 
                        updateProgress(); 
                        updateMultiSelectState(containerId, maxSelection); 
                        return; 
                    }
                    
                    const selectedCards = container.querySelectorAll('.selected');
                    if (card.classList.contains('selected')) { 
                        card.classList.remove('selected'); 
                    } else { 
                        if (selectedCards.length < maxSelection) { 
                            card.classList.add('selected'); 
                        } 
                    }
                    updateMultiSelectState(containerId, maxSelection);
                    updateProgress();
                });
            }

            function updateMultiSelectState(containerId, maxSelection) {
                 const container = document.getElementById(containerId);
                 if (!container) return;
                 const newSelectedCount = container.querySelectorAll('.selected').length;
                 container.querySelectorAll('.uchiake-card').forEach(c => {
                    if (newSelectedCount >= maxSelection && !c.classList.contains('selected')) { c.classList.add('max-selected'); } else { c.classList.remove('max-selected'); }
                });
            }

            function setupSingleSelect(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.addEventListener('click', (e) => {
                    const card = e.target.closest('.uchiake-card');
                    if (!card) return;
                    container.querySelectorAll('.uchiake-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    updateProgress();
                });
            }

            const customCardModal = document.getElementById('custom-card-modal');
            const customCardOverlay = document.getElementById('custom-card-overlay');
            const customCardContent = document.getElementById('custom-card-content');
            const customCardInput = document.getElementById('custom-card-input');
            const customCardSaveBtn = document.getElementById('custom-card-save');
            const customCardCancelBtn = document.getElementById('custom-card-cancel');
            let currentTargetContainerId = null;

            function openCustomCardModal(targetContainerId) {
                currentTargetContainerId = targetContainerId;
                customCardInput.value = '';
                customCardModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                setTimeout(() => { customCardOverlay.classList.remove('opacity-0'); customCardContent.classList.remove('scale-95', 'opacity-0'); }, 10);
            }

            function closeCustomCardModal() {
                customCardOverlay.classList.add('opacity-0');
                customCardContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { customCardModal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }, 300);
            }

            customCardSaveBtn.addEventListener('click', () => {
                const text = customCardInput.value.trim();
                if (text && currentTargetContainerId) {
                    const container = document.getElementById(currentTargetContainerId);
                    const newCard = document.createElement('div');
                    newCard.className = 'uchiake-card custom-card bg-white p-3 rounded-lg shadow-sm border flex flex-col items-center justify-center text-center selected';
                    newCard.innerHTML = `
                        <div class="selected-checkmark"><i class="fas fa-check text-xs"></i></div>
                        <button class="custom-card-remove-btn">&times;</button>
                        <div class="icon-container w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 text-xl mb-2 transition-colors">
                            <i class="fa-solid fa-pencil"></i>
                        </div>
                        <span class="text-xs font-semibold text-gray-700">${text}</span>
                    `;
                    container.insertBefore(newCard, container.querySelector('.add-custom-card'));
                    const maxSelection = (currentTargetContainerId === 'stance-cards') ? 1 : 3;
                    updateMultiSelectState(currentTargetContainerId, maxSelection);
                    updateProgress();
                    closeCustomCardModal();
                }
            });
            customCardCancelBtn.addEventListener('click', closeCustomCardModal);
            customCardOverlay.addEventListener('click', closeCustomCardModal);

            function setupTagInput(button) {
                const inputId = button.dataset.input;
                const containerId = button.dataset.container;
                const inputEl = document.getElementById(inputId);
                const containerEl = document.getElementById(containerId);

                function addTag() {
                    const value = inputEl.value.trim();
                    if (value) {
                        const tag = document.createElement('span');
                        tag.className = 'tag';
                        tag.textContent = value;
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'tag-remove-btn';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = () => {
                            tag.remove();
                            updateProgress();
                        };
                        tag.appendChild(removeBtn);
                        containerEl.appendChild(tag);
                        inputEl.value = '';
                        updateProgress();
                    }
                }
                button.addEventListener('click', addTag);
                inputEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addTag();
                    }
                });
            }
            document.querySelectorAll('.add-tag-btn').forEach(setupTagInput);

            // --- きっかけボタンのロジック ---
            const bioTextarea = document.getElementById('bio');
            const promptButtons = document.getElementById('prompt-buttons');
            
            function generatePromptText(topic) {
                let text = '';
                switch(topic) {
                    case 'me':
                        text = '## わたしのこと\n・（ここに自己紹介を書いてみましょう）\n・（休日の過ごし方など）\n';
                        break;
                    case 'hobby':
                        const hobbyCards = Array.from(document.querySelectorAll('#value-cards .selected, #coping-cards .selected, #selfcare-cards .selected'));
                        const hobbies = hobbyCards.map(c => `「${c.querySelector('span').textContent}」`).join('、');
                        text = '## 好きなこと・趣味\n';
                        if (hobbies) {
                            text += `（${hobbies}がお好きなんですね！)\n`;
                        }
                        text += '・（好きなことについて、自由に書いてみましょう）\n';
                        break;
                    case 'health':
                        const diseaseTags = Array.from(document.querySelectorAll('#tags-container-disease .tag')).map(t => `「${t.textContent.replace('×','').trim()}」`).join('、');
                        text = '## 病気や症状について\n';
                        if (diseaseTags) {
                             text += `（${diseaseTags}について、差し支えのない範囲で教えてください）\n`;
                        }
                        text += '・いつ頃からですか？\n・どんな時に症状が出ますか？\n・普段どんな工夫をしていますか？\n';
                        break;
                    case 'community':
                        const stanceCard = document.querySelector('#stance-cards .selected span');
                        text = '## うちあけで話したいこと\n';
                         if (stanceCard) {
                             text += `（「${stanceCard.textContent}」と考えているんですね！）\n`;
                        }
                        text += '・（この場所で、どんな風に過ごしたいですか？）\n';
                        break;
                }
                return text;
            }

            promptButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.prompt-button');
                if (button) {
                    const topic = button.dataset.topic;
                    const promptText = generatePromptText(topic);
                    
                    const currentText = bioTextarea.value;
                    const textToInsert = (currentText.length > 0 && !currentText.endsWith('\n\n')) 
                        ? `\n\n${promptText}` 
                        : promptText;

                    bioTextarea.value += textToInsert;
                    bioTextarea.focus();
                    bioTextarea.scrollTop = bioTextarea.scrollHeight;
                    updateProgress();
                }
            });

            // --- プロフィール充実度メーターのロジック ---
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            const progressMessage = document.getElementById('progress-message');
            const nicknameInput = document.getElementById('nickname');

            function updateProgress() {
                let completedTasks = 0;
                const totalTasks = 7; 
                const messages = [];

                completedTasks++; // Profile Image
                if (nicknameInput.value.trim() !== '') { completedTasks++; } else { messages.push('ニックネーム'); }
                if (bioTextarea.value.trim().length >= 20) { completedTasks++; } else { messages.push('自己紹介(20文字以上)'); }
                
                const hasMedicalInfo = document.querySelector('#tags-container-disease .tag, #tags-container-treatment .tag, #tags-container-care .tag');
                if (hasMedicalInfo) { completedTasks++; } else { messages.push('わたしのからだ記録'); }

                if (document.querySelectorAll('#value-cards .selected').length > 0) { completedTasks++; } else { messages.push('大切なこと'); }
                if (document.querySelectorAll('#coping-cards .selected').length > 0) { completedTasks++; } else { messages.push('気分の落ち込み対処法'); }
                if (document.querySelectorAll('#selfcare-cards .selected').length > 0) { completedTasks++; } else { messages.push('セルフケア'); }

                const percentage = Math.round((completedTasks / totalTasks) * 100);
                progressBar.style.width = `${percentage}%`;
                progressPercent.textContent = `${percentage}%`;

                if (percentage === 100) {
                    progressMessage.textContent = '素晴らしいです！すべての項目が入力されました。';
                    progressBar.classList.remove('bg-amber-500');
                    progressBar.classList.add('bg-green-500');
                } else {
                    progressMessage.innerHTML = `あと<strong>${messages.join('、')}</strong>を入力すると、他の人と繋がりやすくなります！`;
                    progressBar.classList.remove('bg-green-500');
                    progressBar.classList.add('bg-amber-500');
                }
            }

            [nicknameInput, bioTextarea].forEach(el => el.addEventListener('input', updateProgress));
            
            // --- 初期化処理 ---
            renderCards('value-cards', cardData.values, true);
            renderCards('coping-cards', cardData.coping, true);
            renderCards('selfcare-cards', cardData.selfcare, true);
            renderCards('stance-cards', cardData.stance);

            setupMultiSelect('value-cards', 3);
            setupMultiSelect('coping-cards', 3);
            setupMultiSelect('selfcare-cards', 3);
            setupSingleSelect('stance-cards');

            updateProgress(); // Initial check
        });
    </script>
</body>
</html>
